apiVersion: v1
kind: Secret
metadata:
  name: {{ printf "%s-%s" $.Release.Name "secrets"  }}
  annotations:
    "helm.sh/resource-policy": "keep"
type: Opaque
data:
  ## Secrets Change when the release is upgraded
  ## https://github.com/helm/helm-www/issues/1259
  ## This is a workaround to keep the secrets unchanged
  {{- if .Release.IsUpgrade }}

  internal-smtp: {{ index (lookup "v1" "Secret" $.Release.Namespace (printf "%s-secrets" $.Release.Name)).data "internal-smtp" }}
  oneuptime-secret: {{ index (lookup "v1" "Secret" $.Release.Namespace (printf "%s-secrets" $.Release.Name)).data "oneuptime-secret" }}
  encryption-secret: {{ index (lookup "v1" "Secret" $.Release.Namespace (printf "%s-secrets" $.Release.Name)).data "encryption-secret" }}

  {{- range $key, $val := $.Values.probes }}
  {{- if (index (lookup "v1" "Secret" $.Release.Namespace (printf "%s-secrets" $.Release.Name)).data (printf "probe-%s" $key)) }}
  {{printf "probe-%s" $key}}: {{ (index (lookup "v1" "Secret" $.Release.Namespace (printf "%s-secrets" $.Release.Name)).data (printf "probe-%s" $key)) }}
  {{ else }}
  {{printf "probe-%s" $key}}: {{ randAlphaNum 32 | b64enc | quote }}
  {{- end }}
  {{- end }}

  {{ else }} # install operation

  internal-smtp: {{ randAlphaNum 32 | b64enc | quote }}
  oneuptime-secret: {{ randAlphaNum 32 | b64enc | quote }}
  encryption-secret: {{ randAlphaNum 32 | b64enc | quote }}


  {{- range $key, $val := $.Values.probes }}
  {{printf "probe-%s" $key}}: {{ randAlphaNum 32 | b64enc | quote }}
  {{- end }}

  {{ end }}

---

{{-if $.Values.externalPostgres.password -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ printf "%s-%s" $.Release.Name "external-postgres-password"  }}
  annotations:
    "helm.sh/resource-policy": "keep"
type: Opaque
data:
  ## Add secret here for externalPostgresPassword
  data: {{ $.Values.externalPostgres.password }}
{{- end }}
---

{{-if $.Values.externalPostgres.ssl.enabled -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ printf "%s-%s" $.Release.Name "external-postgres-ssl"  }}
  annotations:
    "helm.sh/resource-policy": "keep"
type: Opaque
data:
  ## Add secret here for externalPostgresPassword
  {{- if $.Values.externalPostgres.ssl.ca }}
  ca: {{ $.Values.externalPostgres.ssl.ca }}
  {{- end }}

  {{- if $.Values.externalPostgres.ssl.cert }}
  cert: {{ $.Values.externalPostgres.ssl.cert }}
  {{- end }}

  {{- if $.Values.externalPostgres.ssl.key }}
  key: {{ $.Values.externalPostgres.ssl.key }}
  {{- else }}
{{- end }}
---

  
  