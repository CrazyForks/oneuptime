name: MCP Server Verification

on:
  pull_request:
  push:
    branches:
      - main
      - master
      - develop
  workflow_dispatch: # Allow manual trigger

jobs:
  verify-mcp-server:
    runs-on: ubuntu-latest
    env:
      CI_PIPELINE_ID: ${{ github.run_number }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: latest
          cache: 'npm'

      - name: Install Common dependencies
        run: cd Common && npm install

      - name: Verify MCP server directory
        run: |
          MCP_DIR="./MCP"
          
          # Check if MCP server directory exists
          if [ ! -d "$MCP_DIR" ]; then
            echo "‚ùå MCP server directory not found"
            exit 1
          fi
          echo "‚úÖ MCP server directory found: $MCP_DIR"
          
          # Count source files
          TS_FILES=$(find "$MCP_DIR" -name "*.ts" | wc -l)
          echo "üìä TypeScript source files: $TS_FILES"
          
          if [ "$TS_FILES" -eq 0 ]; then
            echo "‚ùå No TypeScript files found"
            exit 1
          fi
          
          # Check for essential files
          if [ -f "$MCP_DIR/package.json" ]; then
            echo "‚úÖ Package.json file exists"
          else
            echo "‚ùå Package.json file missing"
            exit 1
          fi
          
          if [ -f "$MCP_DIR/README.md" ]; then
            echo "‚úÖ Documentation exists"
          fi
          
          if [ -f "$MCP_DIR/Index.ts" ]; then
            echo "‚úÖ Main entry point exists"
          else
            echo "‚ùå Main entry point missing"
            exit 1
          fi
          
          if [ -f "$MCP_DIR/Dockerfile.tpl" ]; then
            echo "‚úÖ Dockerfile template exists"
          else
            echo "‚ùå Dockerfile template missing"
            exit 1
          fi
          
          # Show directory structure for debugging
          echo "üìÅ MCP server directory structure:"
          ls -la "$MCP_DIR" || true

      - name: Test MCP server build
        run: |
          MCP_DIR="./MCP"
          if [ -d "$MCP_DIR" ] && [ -f "$MCP_DIR/package.json" ]; then
            cd "$MCP_DIR"
            echo "üî® Installing dependencies..."
            npm install
            echo "üî® Testing TypeScript build..."
            npm run build
            echo "‚úÖ MCP server build successful"
            
            # Show build output
            echo "üì¶ Build output:"
            ls -la build/ || true
            
            echo "üß™ Running tests..."
            npm test || echo "‚ö†Ô∏è No tests found or tests failed"
          else
            echo "‚ùå Cannot test build - missing package.json or MCP server directory"
            exit 1
          fi

      - name: Upload MCP server as artifact
        uses: actions/upload-artifact@v4
        with:
          name: mcp-server-build
          path: ./MCP/
          retention-days: 30
